<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Comment System</title>
    <!-- This is a standalone example. The user can copy the body's content into their site. -->
    
    <!-- STEP 1: Link to the hosted CSS file -->
    <link rel="stylesheet" href="https://appcomment.web.app/index.css">

    <!-- Recommended: Add Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <!-- Add this entire firebase-comments-widget block to your page where you want comments -->
    <div class="firebase-comments-widget">
        <div class="container">
            <header>
                <h1>Join the Conversation</h1>
                <p>Leave a comment below</p>
            </header>

            <section class="comment-form-section" hidden>
                <form id="comment-form">
                    <div class="form-group">
                        <label for="name">Name</label>
                        <input type="text" id="name" placeholder="Your name" required aria-label="Name" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="comment">Comment</label>
                        <textarea id="comment" rows="4" placeholder="Write your comment..." required aria-label="Comment" maxlength="1000"></textarea>
                        <div class="char-counter-wrapper">
                            <span id="char-counter">0 / 1000</span>
                        </div>
                    </div>
                    <button type="submit" id="submit-button">Post Comment</button>
                </form>
            </section>

            <hr>

            <section class="comments-section">
                <h2>Comments</h2>
                <div id="comments-list">
                    <!-- Dynamic content is loaded here -->
                </div>
            </section>
        </div>
    </div>
    
    <!-- STEP 2: Link to the hosted JavaScript file at the end of your body -->
   <script type="module">
// Import functions from the Firebase v9 SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    orderBy, 
    onSnapshot,
    serverTimestamp,
    doc,
    deleteDoc,
    getDocs
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

// =================================================================================
// üî•üî•üî• ACTION REQUIRED: PASTE YOUR FIREBASE CONFIGURATION HERE üî•üî•üî•
// =================================================================================
// 1. Go to your Firebase project's settings.
// 2. Under "Your apps", find your web app.
// 3. Under "SDK setup and configuration", copy the config object.
// 4. Paste it here to replace the placeholder object below.
// =================================================================================
const firebaseConfig = {
  apiKey: "AIzaSyCFIKqQ5OICMZhWPtZqmgem0bEW7QpoPcw",
  authDomain: "appcomment.firebaseapp.com",
  projectId: "appcomment",
  storageBucket: "appcomment.firebasestorage.app",
  messagingSenderId: "156258808941",
  appId: "1:156258808941:web:04a1f7470ac43657c7fb64",
  measurementId: "G-2HX1M5QQ44"
};


// --- Declare variables for DOM Elements ---
let commentFormSection, commentForm, nameInput, commentInput, submitButton, commentsList, charCounter;

// --- Firebase and DB instance ---
let db;

// --- Main Application Logic ---

function showConfigError() {
    const commentsListElement = document.getElementById('comments-list');
    if(commentsListElement) {
        commentsListElement.innerHTML = `
            <div class="config-error">
                <h3><span class="emoji">‚öôÔ∏è</span> Action Required: Connect Your Firebase Project</h3>
                <p>This comment widget isn't connected to a database yet. To make it work, you need to configure it with your own Firebase project credentials.</p>
                <p><strong>Don't worry, it's a one-time setup!</strong></p>
                
                <h4>Step 1: Get your Firebase Config</h4>
                <p>If you don't have one, create a new project at <a href="https://console.firebase.google.com/" target="_blank" rel="noopener noreferrer">Firebase Console</a>, add a web app, and you'll be given a <code>firebaseConfig</code> object.</p>

                <h4>Step 2: Update the Code</h4>
                <p>Open the <code>index.js</code> file on your web server and find the <code>firebaseConfig</code> object near the top. Replace the placeholder values (like <code>"YOUR_API_KEY"</code>) with the actual values from your Firebase project.</p>

                <h4>Step 3: Enable Firestore & Set Rules</h4>
                <p>In your Firebase project dashboard:</p>
                <ol>
                    <li>Go to the <strong>Firestore Database</strong> section and create a new database in <strong>production mode</strong>.</li>
                    <li>Go to the <strong>Rules</strong> tab and paste the following rules to allow anyone to read and write comments.
                        <pre><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // This allows read/write access to any document in any collection
    // Be sure this is what you want for a public comment section.
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code></pre>
                    </li>
                    <li>Click <strong>Publish</strong>.</li>
                </ol>
                 <p class="final-note">Once you've done these steps, refresh your webpage, and the comment section will be live!</p>
            </div>
        `;
    }
}

function showConnectionError(error) {
    const commentsListElement = document.getElementById('comments-list');
    if(commentsListElement) {
        commentsListElement.innerHTML = `
            <div class="config-error">
                <h3><span class="emoji">üîå</span> Firebase Connection Error</h3>
                <p>We see you've added a Firebase configuration, but we couldn't connect. This often happens if the website's address (domain) isn't authorized in your Firebase project.</p>
                
                <h4>Troubleshooting Steps:</h4>
                <ol>
                    <li>
                        <strong>IMPORTANT: Authorize Your Website's Domain</strong><br>
                        This is the most common fix. In your <a href="https://console.firebase.google.com/" target="_blank" rel="noopener noreferrer">Firebase Console</a>, go to:
                        <br><strong>Authentication ‚Üí Settings ‚Üí Authorized domains</strong>.<br>
                        Click "Add domain" and enter the domain of the website where you are using the comments (e.g., <code>yourwebsite.com</code>).
                    </li>
                    <li><strong>Correct Credentials:</strong> Double-check that the <code>apiKey</code> and <code>projectId</code> in your <code>index.js</code> exactly match your Firebase project's web app config.</li>
                    <li><strong>Firestore Database Enabled:</strong> Have you gone to the "Firestore Database" section in your Firebase project and clicked "Create database"? This is a required step.</li>
                    <li><strong>Security Rules:</strong> Ensure your Firestore "Rules" are set up to allow reading/writing, as shown in the initial setup guide.</li>
                    <li><strong>Browser Issues:</strong> Sometimes ad-blockers or strict privacy settings can interfere. Try disabling them for this page.</li>
                </ol>
                 <p class="final-note">For more details, check the browser's developer console (press F12) for the specific error message from Firebase.</p>
                 <p><strong>Original Error:</strong> <code>${escapeHTML(error.message)}</code></p>
            </div>
        `;
    }
}


function initApp() {
    // Find elements within the host page
    commentFormSection = document.querySelector('.comment-form-section');
    commentForm = document.getElementById('comment-form');
    nameInput = document.getElementById('name');
    commentInput = document.getElementById('comment');
    submitButton = document.getElementById('submit-button');
    commentsList = document.getElementById('comments-list');
    charCounter = document.getElementById('char-counter');

    if (!commentFormSection || !commentsList) {
        console.error("Firebase Comments: Required HTML elements not found. Make sure your HTML includes the necessary structure (e.g., .comment-form-section and #comments-list).");
        return;
    }

    commentsList.innerHTML = `
        <div class="spinner-container">
            <div class="spinner"></div>
            <p>Connecting to database...</p>
        </div>
    `;

    try {
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
             throw new Error("Invalid Firebase API Key: Please replace placeholder values in firebaseConfig.");
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);

        commentFormSection.hidden = false;
        
        commentForm.addEventListener('submit', handleFormSubmit);
        commentInput.addEventListener('input', updateCharCounter);
        
        const commentsQuery = query(collection(db, 'comments'), orderBy('timestamp', 'desc'));
        
        onSnapshot(commentsQuery, 
            displayComments,
            (error) => {
                console.error("Firestore snapshot error:", error.code, error.message);
                let userMessage = '<p class="error-message">Could not load comments. An unknown error occurred.</p>';
                if (error.code === 'permission-denied') {
                    userMessage = `<div class="config-error"><h3>Permission Denied</h3><p>Could not fetch comments. Check your <strong>Firestore Security Rules</strong>.</p></div>`;
                } else if (error.message && error.message.includes("Cloud Firestore backend")) {
                     userMessage = `<div class="config-error"><h3>Connection Failed</h3><p>Could not connect to the database. Check your internet, ensure Firestore is created, and check ad-blockers.</p></div>`;
                }
                commentsList.innerHTML = userMessage;
            }
        );
        updateCharCounter();

    } catch (error) {
        console.error("Firebase initialization error:", error);
        if (error.message.includes("Invalid Firebase API Key")) {
            showConfigError();
        } else {
            showConnectionError(error);
        }
    }
}

async function handleFormSubmit(event) {
    event.preventDefault();
    const name = nameInput.value.trim();
    const comment = commentInput.value.trim();
    if (name === '' || comment === '') return;

    submitButton.disabled = true;
    submitButton.textContent = 'Posting...';

    try {
        await addDoc(collection(db, 'comments'), {
            name: name,
            comment: comment,
            timestamp: serverTimestamp()
        });
        commentForm.reset();
        updateCharCounter();
    } catch (error) {
        console.error("Error adding comment:", error.message);
        alert("Error submitting comment. Check console for details.");
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Post Comment';
    }
}

function displayComments(snapshot) {
    commentsList.innerHTML = '';
    if (snapshot.empty) {
        commentsList.innerHTML = `<div class="no-comments"><p><strong>No comments yet.</strong></p><p>Be the first to post a comment!</p></div>`;
        return;
    }
    snapshot.forEach(doc => {
        try {
            const commentElement = createCommentElement(doc.id, doc.data());
            commentsList.appendChild(commentElement);
            fetchAndDisplayReplies(commentElement, ['comments', doc.id, 'replies']);
        } catch (error) {
            console.error("Failed to render a comment:", error.message, doc.data());
        }
    });
}

async function handleReplySubmit(event, replyCollectionPath) {
    event.preventDefault();
    const form = event.target;
    const nameInputReply = form.querySelector('.reply-name-input');
    const textarea = form.querySelector('.reply-text-input');
    const name = nameInputReply.value.trim();
    const replyText = textarea.value.trim();

    if (name === '' || replyText === '') {
        alert("Please provide both a name and a reply.");
        return;
    };

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    try {
        await addDoc(collection(db, ...replyCollectionPath), { name: name, comment: replyText, timestamp: serverTimestamp() });
        const container = form.closest('.reply-form-container');
        if (container) {
            container.style.display = 'none';
            container.innerHTML = '';
        }
    } catch (error) {
        console.error("Error adding reply:", error.message);
        alert("Failed to post reply. Please check your Firestore Security Rules.");
        submitBtn.disabled = false;
    }
}

async function deleteDocAndSubcollections(pathSegments) {
    const repliesPath = [...pathSegments, 'replies'];
    const repliesSnapshot = await getDocs(collection(db, ...repliesPath));
    const deletePromises = repliesSnapshot.docs.map(replyDoc => deleteDocAndSubcollections([...repliesPath, replyDoc.id]));
    await Promise.all(deletePromises);
    await deleteDoc(doc(db, ...pathSegments));
}

async function handleDeleteClick(pathSegments) {
    if (!confirm("Are you sure you want to delete this item and all of its replies?")) return;
    try {
        await deleteDocAndSubcollections(pathSegments);
    } catch(error) {
        console.error("Error deleting document: ", error.message);
        alert("Could not delete item. See console for details.");
    }
}

function fetchAndDisplayReplies(parentElement, repliesCollectionPath) {
    const repliesContainer = parentElement.querySelector('.replies-container');
    if (!repliesContainer) return;

    const repliesQuery = query(collection(db, ...repliesCollectionPath), orderBy('timestamp', 'asc'));
    onSnapshot(repliesQuery, (snapshot) => {
        repliesContainer.innerHTML = '';
        snapshot.forEach((doc) => {
            try {
                const replyElement = createReplyElement(doc.id, doc.data(), repliesCollectionPath);
                repliesContainer.appendChild(replyElement);
                const subReplyCollectionPath = [...repliesCollectionPath, doc.id, 'replies'];
                fetchAndDisplayReplies(replyElement, subReplyCollectionPath);
            } catch (error) {
                 console.error("Failed to render a reply:", error.message, doc.data());
            }
        });
    });
}

function createCommentElement(id, data) {
    const element = document.createElement('div');
    element.classList.add('comment-item');
    element.dataset.id = id;
    const date = timeAgo(safeToDate(data.timestamp));
    const path = ['comments', id];

    element.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${escapeHTML(data.name)}</span>
            <span class="comment-date">${date}</span>
        </div>
        <p class="comment-body">${escapeHTML(data.comment)}</p>
        <div class="comment-actions">
            <button class="action-btn reply-btn" aria-label="Reply">Reply</button>
            <button class="action-btn delete-btn" aria-label="Delete">Delete</button>
        </div>
        <div class="reply-form-container" style="display: none;"></div>
        <div class="replies-container"></div>
    `;

    element.querySelector('.reply-btn').addEventListener('click', () => toggleReplyForm(element, ['comments', id]));
    element.querySelector('.delete-btn').addEventListener('click', () => handleDeleteClick(path));
    return element;
}

function createReplyElement(id, data, parentCollectionPath) {
    const element = document.createElement('div');
    element.classList.add('comment-item', 'reply-item');
    element.dataset.id = id;
    const date = timeAgo(safeToDate(data.timestamp));
    const myPath = [...parentCollectionPath, id];

    element.innerHTML = `
        <div class="comment-header">
            <span class="comment-author">${escapeHTML(data.name)}</span>
            <span class="comment-date">${date}</span>
        </div>
        <p class="comment-body">${escapeHTML(data.comment)}</p>
        <div class="comment-actions">
            <button class="action-btn reply-btn" aria-label="Reply">Reply</button>
            <button class="action-btn delete-btn" aria-label="Delete">Delete</button>
        </div>
        <div class="reply-form-container" style="display: none;"></div>
        <div class="replies-container"></div>
    `;
    
    element.querySelector('.reply-btn').addEventListener('click', () => toggleReplyForm(element, myPath));
    element.querySelector('.delete-btn').addEventListener('click', () => handleDeleteClick(myPath));
    return element;
}

function toggleReplyForm(commentElement, collectionPathToPostTo) {
    const replyFormContainer = commentElement.querySelector('.reply-form-container');
    if (replyFormContainer.style.display === 'none') {
        document.querySelectorAll('.reply-form-container').forEach(c => { c.style.display = 'none'; c.innerHTML = ''; });
        replyFormContainer.style.display = 'block';
        replyFormContainer.innerHTML = `
            <form class="reply-form">
                <div class="form-group"><input type="text" class="reply-name-input" placeholder="Your name" required maxlength="50" aria-label="Your Name for Reply"></div>
                <div class="form-group"><textarea class="reply-text-input" rows="2" placeholder="Write a reply..." required maxlength="500" aria-label="Reply text"></textarea></div>
                <div class="reply-form-actions">
                    <button type="submit">Post Reply</button>
                    <button type="button" class="cancel-reply-btn">Cancel</button>
                </div>
            </form>`;
        const replyForm = replyFormContainer.querySelector('.reply-form');
        const postPath = [...collectionPathToPostTo, 'replies'];
        replyForm.addEventListener('submit', (e) => handleReplySubmit(e, postPath));
        replyFormContainer.querySelector('.cancel-reply-btn').addEventListener('click', () => {
            replyFormContainer.style.display = 'none';
            replyFormContainer.innerHTML = '';
        });
        replyForm.querySelector('input.reply-name-input').focus();
    } else {
        replyFormContainer.style.display = 'none';
        replyFormContainer.innerHTML = '';
    }
}

function updateCharCounter() {
    if (commentInput) {
        const currentLength = commentInput.value.length;
        const maxLength = commentInput.maxLength;
        charCounter.textContent = `${currentLength} / ${maxLength}`;
    }
}

function escapeHTML(str) {
    if (typeof str !== 'string') str = '';
    const p = document.createElement('p');
p.textContent = str;
    return p.innerHTML;
}

function safeToDate(timestamp) {
    return (timestamp && typeof timestamp.toDate === 'function') ? timestamp.toDate() : null;
}

function timeAgo(date) {
    if (!date) return 'Just now';
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 5) return "just now";
    let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
}

// Start the application logic once the page is loaded
document.addEventListener('DOMContentLoaded', initApp);</script>

</body>
</html>
